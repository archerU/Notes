# 开阳AB实验平台的设计理念

Tesla的原理是基于Google论文“Overlapping Experiment Infrastructure More, Better, Faster Experimentation”

- 均匀分流
- 流量灰度
- 数据可信度（置信度）

## 电商中的实验类型


| 实验类型 | 影响程度 | 变更频率 | 实验目标 | 
| --- | --- | --- | --- |
| UI 修改 | 小 | 高 | 用户操作体验，各指标影响 |
| 业务逻辑和算法变更 | 中大 | 高 | 各指标影响 |
| 新功能/页面上线 | 中 | 中 | 测试功能、灰度发布、效果分析 |
| 整体页面改版 | 大 | 低 | 新旧版本对比 |

## 早期实验田

流量被分割成100份，每个实验田占有其中几份。

**并发低**：一个实验田只能进行一个实验。
**周期长**：一个实验至少稳定3天以上才能看到效果。
**门槛高**：除了开发，运营，产品很难去发布实验。
**实验准确性低**：一旦实验比较多，流量有限，流量稀释后，实验效果波动大，实验效果可信度低。

## 开阳目标

**提高并发**：支持并发实验
**缩短实验周期**：建立实时的实验报表
**降低门槛**：提供实验管理工具
**建立闭环**：想法、实验前线下评估、发布实验、实验进行、实验评估、最后实验总结，确保实验结果的质量。

### 核心概念

- 流量容器（Domain)，流量容器可以嵌套多个Layer
- 流量复用层（Layer)，流量复用流经的一个层，流量流经layer 会进行流量切流，可以嵌套多个 domain
- 流量的通道（Experiment)，一个流量的通道，包含实验的参数
- 流量切分规则（Diversion)，流量的筛选条件

### 分层实验
如何流量复用：流量依次流入每层，从而并行地进行多个实验。

**前提**：不同层之间没有交集
**特点**：同一时间可以做 N 个实验，同一份流量不同实验之间不干扰，每个实验都能得到 100% 流量。一份流量穿越每层实验时，都会随机打散，且随机效果离散。
**缺点**：流量复用的缺陷就是不同实验影响力的强弱对最终结论的干扰。

### 互斥实验
	
实验在同一层拆分流量，且不论如何拆分，不同组的流量是不重叠的
	
### 正交实验

每个独立实验为一层，层与层之间流量是正交的，一份流量穿越每层实验时，都会再次随机打散，且随机效果离散。

### 置信度（P-value）与 置信区间



### 实验方案

#### 1、 Hash 设计 - MD5

MD5 特点：
- 压缩性：任意长度的数据，算出的MD5值长度都是固定的。
- 容易计算：从原数据计算出MD5值很容易。
- 抗修改性：对原数据进行任何改动，哪怕只修改1个字节，所得到的MD5值都有很大区别。(重要理论依据!)
- 弱抗碰撞：已知原数据和其MD5值，想找到一个具有相同MD5值的数据（即伪造数据）是非常困难的。
- 强抗碰撞：想找到两个不同的数据，使它们具有相同的MD5值，是非常困难的。

```
理论上，如果我们采用MD5计算hash值，对每个cookie 加上某固定字符串（离散因子），求余的结果，就会与不加产生很大区别。加上离散因子后，当数据样本够大的时候，基于概率来看，所有cookie的分桶就会被再次随机化。

（cookie+离散值）再 MD5，再求余
```

### 难点：

- 为了达到不同的 layer 流量是正交的，设计 hash 函数会很复杂，流量切分也很难做到简单，且具可解释性。
	- hash 离散怎么做？涉及分桶分层算法？为了流量均匀分配到各个桶中。
- 自动化部署，一旦实验推全后，怎么不需要代码级别修改上线实验。实验能够切换到全量发布。
- 动态实时的根据数据反馈调整实验桶占比，可以迅速得到收益并且在大流量上验证改实验的有效性。

理论上，分层实验能够同时并行无数的实验，但是不建议设计如此复杂的实验，一方面流量是有限的，流量稀疏时，效果波动会很大，实验效果置信低。

理论：大质数素数hash算法等更加精密优良的算法


## 流程图




## 一些高级理念

- 辛普森悖论
- 局部贪心优化
- 全局最优的策略